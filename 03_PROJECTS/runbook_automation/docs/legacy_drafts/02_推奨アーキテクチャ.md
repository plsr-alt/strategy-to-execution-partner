# 手順書自動化 — 推奨アーキテクチャ設計
_作成: 2026-02-20_

---

## 1. MVP案（最速で価値が出る形）

### コンセプト
**「キャプチャ画像をDropboxに置くだけで、Google Sheetsに自動転記される」**
→ 人の作業は「確認・承認」だけにする。まず1フローを完成させる。

### MVPアーキテクチャ

```
[手順書キャプチャ画像]
        │ (S3またはGoogle Drive/Dropboxに置く)
        ▼
[AWS Lambda: トリガー]
        │
        ▼
[AWS Textract]
  AnalyzeDocument API
  → Key-Value / Tables 抽出
        │
        ▼
[Amazon Bedrock (Claude)]
  OCRテキスト + フィールド定義 → JSON正規化
  信頼度スコア付き出力
        │
   ┌────┴────┐
   │低信頼度  │高信頼度
   ▼         ▼
[Sheets:   [Sheets:
 要確認フラグ付] 自動書込済]
        │
        ▼
[担当者がSheets確認・修正]
        │
        ▼
[修正ログ → S3保存（改善用）]
```

### MVP の技術スタック

| レイヤー | 採用技術 | 理由 |
|---------|---------|------|
| 画像受取 | S3（EventBridge連携） | シンプル。ドラッグドロップで投入可能 |
| OCR | AWS Textract | フォーム・表構造を構造化JSONで取得。マネージドで運用ゼロ |
| LLM正規化 | Amazon Bedrock (Claude 3.5 Haiku) | 速い・安い・VPC内完結（PII安全）|
| 出力 | Google Sheets API | レビュー・共有・承認フローがスプレッドシートで完結 |
| オーケストレーション | AWS Lambda | サーバーレス。スケールアウト自動 |
| 監査ログ | S3（JSON保存） | 入力画像・OCR結果・LLM出力・最終値を全保存 |

### MVP実装工数（PoC想定）
- Textract連携: 3日
- Bedrock (Claude) 正規化プロンプト: 3日
- Sheets書き込み: 2日
- 信頼度フラグ・レビューUI: 2日
- 結合テスト: 3日
- **合計: 約3週間（1名）**

---

## 2. 本番拡張案

```
[手順書画像]
      │
      ▼
[前処理マイクロサービス]
  画像補正・DPI正規化・分割
      │
      ▼
[AWS Textract]
      │
      ▼
[Amazon Bedrock (Claude 3.5 Sonnet)]
  高精度正規化・欠損検知・マスタ突合
      │
      ▼
[バリデーション層]
  ルールエンジン（型・必須・コード値）
      │
    ┌─┴─┐
    │   │
[自動] [要レビュー]
    │        │
    │    [レビューUI]   ← Sheets or 専用Webアプリ
    │        │
    └──┬─────┘
       │
[SQSキュー]
       │
  ┌────┴────┬──────────┐
  ▼         ▼          ▼
[kintone  [基幹API  [RPA
 API]      登録]    (GUI入力)]
       │
[監査ログDB（S3/Athena）]
       │
[CloudWatch Dashboard]
  処理件数・エラー率・信頼度分布
```

### 本番拡張での追加要素

| 要素 | 説明 |
|------|------|
| 前処理マイクロサービス | 画像品質のバラつきを吸収。Lambda Layerに組み込み |
| マスタ突合 | コード値・氏名リスト等をS3/DynamoDBに持ち、バリデーション時に参照 |
| SQS + Lambda並列処理 | 大量バッチ時に自動スケール |
| RPA（Playwright/Power Automate） | APIがない既存システムへのフォールバック |
| Athena + QuickSight | 処理ログを分析し精度改善に活用 |
| フィードバックループ | 修正データを蓄積 → プロンプト自動改善（月次） |

---

## 3. ロードマップ

### Phase 1（MVP）— 0〜4週間
**ゴール**: 1種類の手順書フローを自動化し、人の作業を「確認」のみにする

- [ ] 対象手順書を1種類選定（最も件数が多いもの）
- [ ] S3 → Textract → Bedrock → Sheets パイプライン構築
- [ ] 信頼度フラグ付き出力
- [ ] 監査ログ保存（S3）
- [ ] PoC結果レポート

### Phase 2（本番化）— 1〜3ヶ月
**ゴール**: 主要3〜5フローを自動化。入力先システムへのAPI登録を実現

- [ ] 前処理マイクロサービス追加
- [ ] バリデーション層実装（ルールエンジン）
- [ ] 入力先システムのAPI連携（kintone等）
- [ ] レビューUIの整備（Sheets or 軽量Webアプリ）
- [ ] 監査ログ・ダッシュボード整備

### Phase 3（スケールアウト）— 3〜6ヶ月
**ゴール**: 全フロー対象。フィードバックループと精度の継続改善

- [ ] 全手順書フロー対応
- [ ] RPA連携（APIなしシステム対応）
- [ ] フィードバックループ自動化
- [ ] Athena + QuickSightによる精度分析ダッシュボード
- [ ] SLA定義と運用体制確立

---

## 4. リスクと対策

| リスク | 深刻度 | 対策 |
|--------|--------|------|
| **OCR精度が低い（手書き・低解像度）** | 高 | 前処理強化 + 信頼度閾値でヒューマンレビュー必須化 |
| **LLMがハルシネーション** | 高 | 出力に信頼度スコア付与。バリデーション層で必ず二重チェック |
| **手順書フォーマットが頻繁に変わる** | 中 | LLMを使うことでレイアウト変化を吸収。ルールベースを最小化 |
| **PII・機密情報の外部送信** | 高 | Amazon Bedrock（VPC内完結）を使用。外部API不使用を原則化 |
| **担当者がレビューをスキップする** | 中 | 信頼度低の場合はSheets入力をロック。承認者の押印必須フローにする |
| **入力先システムのAPI変更** | 低 | API呼び出しをアダプター層に集約。変更時は1箇所修正で済む設計 |

---

## 5. 失敗しやすいポイント

1. **「精度100%を目指してMVPが永遠に出ない」罠**
   → 信頼度スコア + ヒューマンレビューで補う設計にし、80%精度でMVPを出す。

2. **「全フローを一度に自動化しようとする」罠**
   → Phase 1で1フローだけ。価値を実証してからスケールアウト。

3. **「Textract任せで構造化できると思う」罠**
   → 日本語の手順書はTextractのKey-Value精度が低いケースがある。LLMによる後処理が必須。

4. **「ログを取らないまま本番化」罠**
   → MVP段階から全入出力をS3に保存する。後からプロンプト改善に必須。

5. **「RPAを先に検討する」罠**
   → RPAはUI変更で即壊れる。APIまたはファイル出力で解決できるならRPAは最後の手段にする。

---

_参照: [01_方式調査.md](./01_方式調査.md) / [03_PoC設計.md](./03_PoC設計.md)_
