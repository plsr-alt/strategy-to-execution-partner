# 推奨アーキテクチャ（Recommended Architecture）

## 1. MVP構成（最速で価値が出る形）
- **操作エンジン**: Playwright (全エンジニアに配布可能なCLIツールまたは軽量パッケージ化を見据える)
- **UI認識・自己修復**: 方式1（A11y/DOM優先 + AI補正）。基本は固定セレクタ＋A11yロール。失敗時のみローカルLLM/軽量LLMがDOMからセレクタを再推論（Self-healing）。
- **認証情報管理**: 対象システムへのログイン情報は **AWS Secrets Manager** から動的に取得、または都度入力。
- **手順書生成エンジン**: Amazon Bedrock (Claude 3.5 Sonnet Vision)。マスキング不要な生画像をセキュアに解析。
- **大規模手順のチャンク（分割）処理**: VPC、EC2構築など数十ステップに及ぶ操作に耐えるため、10ステップ毎や画面コンテキスト毎にAIへのリクエストを分割し、最後にMarkdownをマージするアーキテクチャ。

## 2. 本番拡張構成
- UI認識に「方式2（Vision × DOMハイブリッド）」を採用。AIが画面を理解し、DOMツリーと結合して操作要素を確定。
- 操作の中断・再開（ヒューマンインザループ）をサポートする専用GUIコンソール。
- 生成した手順書を社内Wiki (Confluence 等) へ直接パブリッシュするAPI連携。

## 3. フェーズ別ロードマップ
- **Phase 1 (MVP: Month 1-2)**: 方式1でのスクリプト自動実行 + キャプチャ取得、および事後的なMarkdown生成パイプラインの構築。対象はAWSコンソールの特定1〜2業務。
- **Phase 2 (拡張: Month 3-4)**: Self-healing 機能の実装。UI小変更時に自動でセレクタを補正。
- **Phase 3 (AI自律性向上: Month 5-)**: 方式2の導入、AIによる「次の一手」の提案と確認（人間承認）ベースの操作。

## 4. リスクと対策
- **リスク**: 破壊的な操作（インスタンス削除など）の自動実行事故。
- **対策**: 操作対象のURL、ボタン（Delete, Terminate等）の「許可リスト/拒否リスト」を実装し、マッチした場合は人間への確認（Wait for interaction）を必須とする。

## 5. 失敗しやすいポイント
- **DOMが巨大すぎる**: AWSコンソール等で全DOMをLLMに投げるとトークンあふれや精度低下を起こす。
  - **対策**: 可視状態（Visible）の要素のみを抽出し、無駄なタグを削るプリプロセッサを挟む。
- **AIエージェントへの依存過多**: 方式3のようにAIにすべて任せると、必ず想定外の操作をする。
  - **対策**: あくまで「スクリプトが主、AIは補正」のスタンスを崩さない。

## 6. ASCIIアーキテクチャ図

```text
[ 操作実行フェーズ (ローカルPC / 踏み台サーバー) ]
 +------------------+           +-------------------+
 |  手順シナリオ    | --------> | Playwright Engine | ----> (Web UI / AWS Console)
 | (JSON/YAML定義)  |           +-------------------+
 +------------------+             |      |       ^
       ^                          v      v       | (DOM/スクショ取得)
       |   [AI Self-healing] <----+      |       |
       |   (LLMによるDOM解析・補正)      |       |
       |                                 |       |
 [AWS Secrets Manager] (認証情報取得)    |       |
                                         |       |
[ 証跡・ログ記録 ]                       |       |
 +------------------+   スクショ +-------------+ |
 | Local Filesystem | <----------| Logger      | |
 | (Logs / Images)  |            +-------------+
 +------------------+
          |
[ ドキュメント生成フェーズ (Chunking API Call) ]
          |(大規模手順の場合は画像を例えば10枚ずつに分割)
          v
 +------------------+    (VPC Endpoint / API)
 | Doc Generator    | ------------------------> [ Amazon Bedrock (Claude Vision) ]
 +------------------+  (セキュアな閉域網で生画像を解析)
          |
          v
 [ 統合された Markdown.md 出力 ]
```
