# キャプチャ & 手順書生成設計

## 1. スクリーンショット取得ルール
- **取得タイミング**:
  1. ページロード完了直後（Before状態）
  2. マウスクリックやキーボード入力などの重要操作を行う**直前**（操作対象をハイライト付きで）
  3. 操作が行われた後、何らかの状態変化（DOM変化・ネットワークアイドル）が完了した**直後**（After状態）
  4. エラー、または例外（タイムアウト等）が発生した瞬間
- **取得範囲**: 基本は「Viewport（可視領域全体）」。監査証跡としてコンテキストを残すため。

## 2. 操作ログ仕様
- JSON Sequence (JSONL) 形式で保存。
- 必須項目:
  - `timestamp`: ISO8601フォーマット
  - `step_id`: 一連の操作の中での連番
  - `action`: `click`, `type`, `select`, `wait`, `error` など
  - `target_selector`: 最終的に使用したセレクタ
  - `target_text`: 操作・取得した要素のテキスト情報
  - `screenshot_path`: 紐付く画像ファイルのパス
  - `healing_applied`: Self-healingが発動したか(boolean)
  - `healing_reason`: 発動した場合、AIが判定した理由文字列

## 3. 画像命名規約
`{YYYYMMDD_HHMMSS}_{step_id}_{action}_{status}.png`
例: `20260223_103015_001_click_before.png`

## 4. マスキング方針
- **対象**: PII（個人情報）、AWSアカウントID、IPアドレス、シークレットキー等。
- **方式**: 
  - DOMレベルでの置換：キャプチャを撮る**直前**に、Playwright側で特定要素（`.account-id`, `[type="password"]`等）内のテキストを `***` に書き換える。これが最も確実で画像処理が不要。
  - 画像レベルのバックアップ：必要に応じ、ローカルで軽量なRegex/OCRベースの黒塗り処理（Tesseract+OpenCV等）を追加適用。

## 5. 手順書テンプレ（Markdown）
生成時にLLMに以下の構造に当てはめるよう指示する。

```markdown
# [システム/機能名] 操作手順書

## 前提
- **作成日時**: {自動挿入}
- **対象環境**: {AWSアカウント名/リージョン等}

## 目的
{一連の操作で何を達成するか}

## 事前準備
- 必要な権限や事前の設定等

## 手順
{Step 1 .. N まで繰り返し}
### Step X: [アクションの要約（例: EC2インスタンス画面への遷移）]
- **操作内容**: [画面左のメニューから「インスタンス」をクリックする] 等
- **設定値**: [入力した場合、その値]
- **理由/目的**: [なぜその操作をしたのか]
![Step X キャプチャ](./images/step_x.png)

## 注意点
- 操作中に発生しやすいエラーや、特記事項

## 検証（確認項目）
- 作業が正しく完了したことを確認する方法

## ロールバック
- 誤った場合や、取り消す必要が生じた場合の手順

## 変更履歴
- YYYY-MM-DD: 新規自動生成
```
