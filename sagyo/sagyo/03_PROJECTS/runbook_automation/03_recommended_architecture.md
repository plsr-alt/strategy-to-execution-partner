# 推奨アーキテクチャ設計

**作成日**: 2026-02-20

---

## 1. 設計方針

1. **段階的拡張**: MVP→半自動→全自動を同一アーキテクチャで継承
2. **人手介入を設計に組み込む**: 精度が低い項目は自動でフラグ立て、人手確認を強制
3. **監査ログは必須**: すべての抽出・変更・承認を記録
4. **ベンダーロック最小化**: AWS主体だが差し替え可能なレイヤー構造

---

## 2. 全体アーキテクチャ図（ASCII）

```
┌─────────────────────────────────────────────────────────────────┐
│                        INPUT LAYER                               │
│  [手順書画像/PDF]  →  [S3 Bucket / ローカル取込]                 │
└────────────────────────────┬────────────────────────────────────┘
                             │ イベントトリガー（S3 Event / API）
┌────────────────────────────▼────────────────────────────────────┐
│                     ORCHESTRATION LAYER                          │
│          [AWS Step Functions / Airflow（代替）]                   │
│   ステップ管理・リトライ・エラー捕捉・ステータス管理              │
└──┬──────────────┬──────────────┬───────────────────────────────┘
   │              │              │
   ▼              ▼              ▼
┌──────┐    ┌──────────┐   ┌──────────────┐
│ Pre- │    │  OCR     │   │  Structure   │
│ proc │    │ Layer    │   │  Extraction  │
│(画像 │    │(Textract │   │(LayoutLM /  │
│前処理│    │ /Paddle) │   │ Textract     │
│傾き補│    │          │   │ Forms)      │
│正・  │    │          │   │              │
│ノイズ│    │          │   │              │
└──┬───┘    └────┬─────┘   └──────┬───────┘
   └────────────┴──────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────┐
│                    NORMALIZATION LAYER                          │
│   [Amazon Bedrock / Claude claude-sonnet-4-6]                          │
│   ・項目揺れ吸収 → JSON正規化                                   │
│   ・スキーマバリデーション                                       │
│   ・confidence スコア付与                                        │
│   ・欠損・異常値フラグ                                           │
└────────────────────────┬───────────────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────────────────┐
│                    VALIDATION LAYER（人手介入ポイント）          │
│   confidence < 閾値 → [確認UI（Web App）] → オペレーター承認    │
│   confidence ≥ 閾値 → 自動通過（Phase2〜）                      │
│   例外（抽出失敗） → アラート → エスカレーション                │
└────────────────────────┬───────────────────────────────────────┘
                         │  承認済みJSON
                         ▼
┌────────────────────────────────────────────────────────────────┐
│                    OUTPUT / INTEGRATION LAYER                   │
│   ┌──────────────┐  ┌─────────────┐  ┌──────────────────────┐ │
│   │ CSV / Sheets │  │ REST API    │  │ RPA / Playwright     │ │
│   │ (Phase1)     │  │ (Phase2〜) │  │ (API非対応システム)  │ │
│   └──────────────┘  └─────────────┘  └──────────────────────┘ │
└────────────────────────┬───────────────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────────────────┐
│                    LOGGING / AUDIT LAYER（全フェーズ必須）      │
│   [DynamoDB / RDS]  ←  全ステップのログ・差分・承認者・時刻     │
│   [CloudWatch]      ←  エラー監視・アラート                     │
│   [S3 Glacier]      ←  長期保管（コンプライアンス）             │
└────────────────────────────────────────────────────────────────┘
                         ↑
               フィードバックループ（Phase3〜）
               [訂正データ] → [再学習パイプライン]
```

---

## 3. MVP案（Phase 1）

### 目的
- 入力ミス削減と作業時間短縮を「入力支援」として最速で実現

### 構成（シンプル化）
```
S3 → Lambda → Textract → Bedrock(Claude) → 確認UI → CSV/Sheets出力
```

### 対象
- 手順書フォーマット: 1種類（固定）
- 処理方式: バッチ（リアルタイム不要）
- 出力: Google Sheets（オペレーターが確認・コピー）
- 人手介入: 全件確認（confidence閾値は参考表示のみ）

### 非スコープ
- 自動登録（コピペ補助まで）
- 複数フォーマット対応
- 学習ループ
- 複数システム連携

### 成功指標（MVP）
| KPI | 目標 |
|-----|------|
| 抽出精度（F1） | ≥ 85% |
| 1件あたり作業時間 | -20% |
| オペレーター満足度 | アンケートで「使いたい」70%以上 |

---

## 4. 本番拡張案（Phase 2〜3）

### Phase 2: 半自動（Month 3〜6）
```
追加要素：
- confidence 閾値による自動/手動の振り分け
- REST API直接登録（既存システム連携）
- エラーキュー・リトライ機構
- 監査ログDB構築
```

### Phase 3: 全自動＋学習ループ（Month 7〜）
```
追加要素：
- 訂正フィードバックをトレーニングデータとして蓄積
- OCR・LLMの定期再評価（月次）
- SageMakerでカスタムモデル補完
- 異常検知（突然の精度劣化をアラート）
- マルチフォーマット対応
```

---

## 5. ロードマップ

```
Month 1:   [PoC] ────────────────────────────────────────────────
           技術検証・評価セット作成・OCR比較・アーキ確定

Month 2-3: [Phase 1 MVP] ────────────────────────────────────────
           S3→Textract→Bedrock→Sheets パイプライン実装
           確認UI（簡易Web）開発・本番投入・モニタリング設定

Month 4-6: [Phase 2 半自動] ─────────────────────────────────────
           confidence閾値チューニング・API連携・監査ログDB
           SLA設計・エラーフロー整備

Month 7+:  [Phase 3 全自動] ─────────────────────────────────────
           フィードバックループ・再学習・マルチフォーマット
           ガバナンス強化（権限管理・PII暗号化）
```

---

## 6. 失敗しやすいポイント（現実的警告）

| ポイント | 症状 | 対策 |
|---------|------|------|
| 精度過信 | 「90%精度」を誤解し全自動化で大量ミス | まず入力支援から。全自動は段階的に |
| 評価セット不足 | 本番データと乖離した精度測定 | 本番と同条件の評価セットを50件以上確保 |
| フォーマット変更 | 手順書のUIが変わって全崩壊 | バージョン管理・差分検知アラートを仕込む |
| PII漏洩 | クラウドOCRに氏名・口座番号を送信 | VPC内完結構成・マスキング前処理 |
| RPA脆弱性 | 画面変更でRPAが誤クリック | RPA範囲を最小化。ドライランモード実装 |
| ログ設計後回し | 後からログ追加が困難 | Day1から監査ログ必須。後付け不可 |
| 確認UIの形骸化 | 「とりあえずOK」クリックが常態化 | UI設計でスキップを難しくする工夫 |
