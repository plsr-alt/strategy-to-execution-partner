# 手順書自動化 — 方式調査
_作成: 2026-02-20_

---

## 1. 画像 → データ抽出方式

### 1-1. OCR（光学文字認識）

| サービス | 特徴 | 向き / 不向き |
|---------|------|--------------|
| **AWS Textract** | マネージド。フォーム・表の構造抽出（Key-Value, Tables）がAPIで完結 | ✅ 印刷物・スキャン・スクショ全般。✅ AWS環境と親和性高い |
| **Google Document AI** | 非構造ドキュメントに強い。事前学習済みプロセッサあり | ✅ 請求書・領収書等の定型フォーム。△ AWS環境とは別管理 |
| **Azure Form Recognizer** | Azure環境前提。カスタムモデル学習可 | ✅ Azureネイティブ環境向け。今回は優先度低 |
| **Tesseract（OSS）** | 無料。精度はサービス系より低い。日本語モデルあり | ✅ 社内閉域環境・コスト制約大。△ 複雑レイアウトは苦手 |
| **PaddleOCR（OSS）** | 中国発OSS。精度高め。日本語対応 | ✅ OSS縛りかつ高精度が必要な場合 |

**精度向上方法（前処理）**
- グレースケール変換・二値化（OpenCV）
- ノイズ除去・傾き補正（deskew）
- DPI正規化（300dpi推奨）
- キャプチャ画像の場合：高解像度での再キャプチャを推奨

---

### 1-2. フォーム・表構造抽出

| 手法 | 説明 |
|------|------|
| **AWS Textract Analyze Document** | `AnalyzeDocument` API で Key-Value ペアと Table を直接取得。構造化データとしてJSON出力 |
| **ルールベース抽出** | 項目位置が固定の手順書であれば、座標ベースの切り出し（OpenCV + 正規表現）で高精度・低コスト |
| **LLMによる構造認識** | 座標情報不要。OCR全文テキストを渡してLLMに表・項目を抽出させる。レイアウト変動に強い |
| **LayoutLM系（HuggingFace）** | 文字位置と意味を同時に学習したモデル。高精度だが学習コスト高 |

---

### 1-3. LLMによる正規化

OCR出力（生テキスト）をLLMに渡し、以下を実施：

| 処理 | 例 |
|------|-----|
| **項目名揺れ吸収** | 「担当者名」「担当」「Name」→ `operator_name` に統一 |
| **JSON化** | 非構造テキスト → `{"field": "value"}` に変換 |
| **欠損検知** | 必須項目が空の場合にフラグを立てる |
| **値の検証** | 日付フォーマット・数値範囲・コードマスタとの照合 |
| **文脈補完** | 前後の文脈から欠損値を推定（信頼度付き） |

**推奨プロンプト設計**
```
以下はOCRで読み取った手順書テキストです。
定義されたフィールドリストに従い、JSONで抽出してください。
値が読み取れない場合は null とし、信頼度（0-1）を添えてください。
---
フィールド定義: {field_definitions}
OCRテキスト: {ocr_text}
```

**モデル選択**
- Claude 3.5 Sonnet / Claude 3.5 Haiku：日本語精度・コスト・速度のバランス最良
- GPT-4o：代替選択肢。ただしAWSエコシステムからはAmazon Bedrock経由でClaude推奨

---

## 2. データ反映方式

### 2-1. 方式一覧

| 方式 | 説明 | 適合ケース |
|------|------|-----------|
| **CSV / Excel出力** | 抽出結果をファイルに書き出し、人が確認してから手動またはインポート | 最小MVP。入力先システムにAPIがない場合 |
| **Google Sheets API** | スプレッドシートに自動書き込み。レビュー・共有が容易 | 全社共有・承認フロー付きで使いやすい |
| **REST API直接登録** | 入力先システムのAPIを叩いて直接データ登録 | APIが公開されている業務システム（kintone等） |
| **RPA（画面自動入力）** | UiPath / Power Automate / Playwright でUIを操作 | APIがなくGUI入力しかない既存システム |
| **中継サーバー方式** | キューに積んで非同期で複数システムに配信（SQS + Lambda等） | 登録先が複数・大量バッチ処理 |
| **ハイブリッド（API + RPA）** | APIが使えるシステムはAPI、そうでないシステムはRPAでフォールバック | 現実の複合環境に最適 |

---

## 3. 方式比較表

| 観点 | OCR単体 | Textract+ルール | Textract+LLM | Claude Vision直接 | RPA |
|------|---------|----------------|--------------|-------------------|-----|
| **実装難易度** | 低 | 中 | 中 | 低 | 高 |
| **初期コスト** | 低（OSS）| 中（API従量）| 中（API従量×2）| 中（API従量）| 高（ライセンス+構築）|
| **運用負荷** | 高（精度管理）| 中 | 低〜中 | 低 | 高（UI変更追随）|
| **壊れにくさ** | △（フォント・レイアウト変化に弱）| △（ルール変化に弱）| ◎（LLMが吸収）| ◎ | △（UI変更で即壊れる）|
| **精度担保** | ルール補完必要 | ルール設計次第 | プロンプト設計＋ヒューマンレビュー | プロンプト設計＋レビュー | UIの安定性次第 |
| **監査ログ** | 要実装 | 要実装 | 要実装（LLMの入出力保存）| 要実装 | ツール依存 |
| **セキュリティ** | ◎（閉域可）| ◎（AWS内完結）| △（外部LLM API利用時）| △（外部API）| ◎（閉域可）|
| **PII対応** | マスキング必要 | マスキング必要 | Bedrock使用でVPC内完結可 | Bedrock使用でVPC内完結可 | ローカル処理可 |
| **スケーラビリティ** | △ | ◎（Lambda連携）| ◎（Lambda連携）| ◎ | △（ライセンス数制限）|

---

## 4. 精度向上の補足

### ルール補完の設計
```
入力値 → LLM出力JSON → バリデーション層
                              ├─ 必須項目チェック
                              ├─ 型チェック（日付・数値）
                              ├─ マスタ突合（コード値・氏名リスト）
                              └─ 信頼度 < 閾値 → 人間レビューキュー
```

### ヒューマンインザループ設計
- 信頼度スコアが 0.85 未満の項目は**自動でレビュー対象フラグ**を立てる
- Sheets上でフラグ付きセルをハイライト → 担当者が確認・修正
- 修正データをフィードバックとして蓄積し、プロンプトを改善

---

_参照: [02_推奨アーキテクチャ.md](./02_推奨アーキテクチャ.md)_
