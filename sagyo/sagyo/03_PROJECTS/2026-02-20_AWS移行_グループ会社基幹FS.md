# AWS移行案件 — グループ会社 基幹システム＆ファイルサーバー
_作成: 2026-02-20 / 提出期限: 2026-02-24（火）_

---

## 0. 依頼文から読み取れる前提条件

| 項目 | 内容 | 確信度 |
|------|------|--------|
| 対象企業 | グループに新規加入した企業 | 確定 |
| 移行先 | AWS EC2（基幹システム） | 確定 |
| 対象① | 基幹システム（EC2新規構築） | 確定 |
| 対象② | ファイルサーバー（データ移行） | 確定 |
| 現ファイルサーバー場所 | Azure（ファイルサーバー） | 確定 |
| 移行先FS | **Amazon FSx for NetApp ONTAP** | **確定** |
| 移行スコープ | データ移行のみ記載。権限・設定は明示なし | 不明 |
| スケジュール | 未定 | 不明 |
| 接続方式 | Azure↔AWS間の経路が不明 | 不明 |

### ⚠️ 残る重要な曖昧点

移行先FSがFSx for NetApp ONTAPと確定したことで、方式の幅が絞られた。
残る曖昧点は以下の2点が特に重要：

- **移行元の種別**: Azure FS が **Azure NetApp Files（ANF）** か **Azure VM上のWindows Server FS** か
  → ANFであれば **SnapMirror** による直接レプリケーションが最有力選択肢となる。ANFでなければDataSync/AzCopy経由となる。
- **ADドメイン統合タイミング**: 移行前・中・後どのタイミングでドメイン統合するか
  → FSx for ONTAPのAD参加設計・権限移行方式が変わる。

---

## 1. リスク整理（内部メモ）

### HIGH（見積もり崩れ・プロジェクト遅延の直接原因）

| # | リスク | 理由 |
|---|--------|------|
| R-01 | Azureと移行先の間にネットワーク経路が未整備 | VPN/DX構築が別途工数。数週間〜数ヶ月スコープ |
| R-02 | ADドメインが別ドメイン（グループ統合前） | NTFS権限のSIDが変わるため、権限移行が大幅工数増 |
| R-03 | 小ファイル多数（数百万件） | 移行時間が容量ではなくファイル数に支配される |
| R-04 | 基幹システムのOS・DB・MW構成不明 | EC2スペック見積もり不能。AMI調達方法も変わる |
| R-05 | カットオーバー時のダウンタイム許容が不明 | 方式選択の根幹。Lift&Shiftか段階移行かも変わる |

### MEDIUM（工数変動要因）

| # | リスク | 理由 |
|---|--------|------|
| R-06 | 移行元がAzure NetApp Files（ANF）か、Azure VM上のWindows FSか | SnapMirror使用可否・ツール選択が根本的に変わる |
| R-07 | FSx for ONTAP の SVM（Storage Virtual Machine）設計未定 | 共有フォルダ設計・プロトコル設計（SMB/NFS/マルチプロトコル）が決まらないと構築できない |
| R-08 | GPO・スクリプト依存のFS構成 | クライアントUNCパスの変更要否・DFS使用の有無に影響 |
| R-09 | 暗号化要件（KMS/SSE等） | FSx for ONTAPの保存時暗号化・転送時暗号化の設定が追加工数 |
| R-10 | バックアップ・DR要件未定義 | FSx for ONTAPのSnapshot/SnapMirror/AWS Backup設計が別途必要 |

### LOW（注意事項）

| # | リスク | 理由 |
|---|--------|------|
| R-11 | FSx for ONTAPのティアリング設定 | FabricPool（S3への自動階層化）の要否により設計・コストが変わる |
| R-12 | 監査ログ保持要件 | ONTAPのファイルアクセス監査ログの保存期間が設計に影響 |
| R-13 | マルチプロトコル（SMB+NFS）要件 | Unixパーミッションモデルとの整合性設計が発生する |

---

## 2. データ移行方式 比較表

### 前提の整理

| 変数 | 影響する方式 |
|------|------------|
| **Azure NetApp Files（ANF）か否か** | **SnapMirrorの使用可否を決定する最重要変数** |
| Azure↔AWSの接続有無 | ネットワーク経由方式の全体 |
| ADドメイン同一 or 別 | 権限移行可否 |
| データ量・ファイル数 | Snow系か否かの判断閾値 |

---

### 方式比較表

| 観点 | **SnapMirror** | DataSync | AzCopy+Robocopy | 中継サーバー | Snowball Edge |
|------|---------------|----------|-----------------|-------------|---------------|
| **適用前提** | **移行元がAzure NetApp Files（ANF）であること** | DataSyncエージェント(VM)が必要。FSx for ONTAPに対応 | Azure FilesへのアクセスとEC2中継サーバーが必要 | 中継EC2またはオンプレサーバー | 物理デバイス手配(2〜4週リードタイム) |
| **ネットワーク要件** | VPN/ExpressRoute経由でANF↔FSx ONTAP間の疎通が必要 | Azure→AWS間の疎通(VPN/DX or インターネット) | AzCopy: インターネット可。Robocopy: SMBポート疎通 | 中継サーバーが両側に接続できること | 不要（オフライン） |
| **権限移行** | ◎ ONTAPレベルで権限情報を保持。ほぼ完全移行 | △ NTFSメタデータ保持可。SID変換は別途対応 | ◎ Robocopy /COPYALLでACL完全コピー（同一ドメイン前提） | ツール依存（Robocopyを乗せればOK） | × データのみ。権限は別途設計 |
| **ダウンタイム** | ◎ 差分レプリケーション後の最終同期のみ停止 | ◎ 差分同期後に短時間停止(本番切替時のみ) | △ 差分Robocopy後に切替。手動管理 | ツール依存 | × 長い(物理輸送) |
| **小ファイル耐性** | ◎ ONTAPブロックレベル転送のためファイル数に依存しない | △ 100万件超はエージェント負荷が上がる | △ /MT(マルチスレッド)で改善。大量小ファイルは時間がかかる | 中継toolに依存 | ◎ ファイル数無関係 |
| **差分同期** | ◎ SnapMirrorの継続レプリケーション機能で自動増分 | ◎ 標準機能。増分タスク設定可 | ◎ /XO(上書きスキップ)で差分対応 | 中継toolに依存 | × 不可 |
| **コスト影響** | ANFとFSx ONTAPのピアリング設定工数 + ネットワーク費 | DataSyncエージェントEC2費用 + 転送GB単価 | 中継EC2費用 + Azureのegress費 | 中継サーバーEC2費 | Snowball機器レンタル + 輸送費 |
| **推奨ユースケース** | **移行元がANFの場合・最短工期・権限完全移行** | Azure VM上FSからの大容量移行 | Azure Files→FSx ONTAP・権限移行必要・汎用 | 接続制約あり・段階移行 | 100TB超・オフサイトバックアップ |

### 推奨パターン（暫定）

**パターンA（最有力・ANF使用時）: SnapMirror直接レプリケーション**
1. Azure NetApp FilesとFSx for NetApp ONTAPをSnapMirror関係で構成（VPN/DX経由）
2. 初回フル同期後、差分レプリケーションを継続
3. カットオーバー当日：最終同期 → SnapMirror関係を解除 → FSx側を本番として切替

**パターンB（Azure VM上Windows FSの場合）: AzCopy + DataSync → FSx for ONTAP**
1. AzCopyでAzure FilesからデータをエクスポートしてS3へ、またはDataSyncエージェントをAzure VMに設置
2. AWS DataSyncでFSx for ONTAPへ直接転送
3. 権限はRobocopy（中継EC2経由）またはスクリプトで別途移行

**パターンC: VPN構築 + SnapMirror/DataSync 段階移行**
- Azure↔AWSのVPN接続を先行構築
- SnapMirror（ANF時）またはDataSync（VM-FS時）で継続同期を繰り返し、本番切替

---

## 3. 権限移行 ヒアリング整理

FSx for NetApp ONTAPはSMBプロトコル経由でNTFS権限をネイティブサポートしているため、AD参加済みのFSx ONTAPへのRobocopy /COPYALLまたはSnapMirrorによる移行は権限を保持できる。
ただし、ADドメインが異なる場合はSID変換が必要。

| 項目 | 確認内容 | 影響 |
|------|----------|------|
| ADドメイン | グループ会社と移行先が同一ドメインか、別ドメインか | SID変換が必要か否かの根幹 |
| ドメイン統合計画 | 移行前後にドメイン統合（マージ）する予定があるか | 権限移行タイミングと設計が変わる |
| SIDHistory | SIDHistoryによる権限継承を利用するか | ADの信頼関係・ツールの選定に影響 |
| NTFS権限の複雑度 | フォルダ階層ごとに個別ACLが設定されているか | 権限の確認・修正工数に直結 |
| 共有権限 | 共有フォルダのアクセス権がどのレベルで設定されているか | 移行後の共有設計（SMB共有はFSx ONTAPで再定義） |
| グループ構造 | セキュリティグループ/配布グループの数・構成 | グループのマッピング工数 |
| Kerberos/LDAP依存 | 基幹システムがAD認証（Kerberos）に依存しているか | FSx ONTAPのAD参加設計・AWS Managed AD使用有無 |
| DNS名前解決 | 現在のFSのUNCパス（\\server\share）を変更可能か | DFS-N使用でパスを透過的に切り替えるかの判断 |
| GPO依存 | FSマッピング・ログインスクリプトにGPO依存があるか | クライアント側の設定変更工数 |
| マルチプロトコル | SMBのみか、NFSも使用するか | FSx ONTAPのSVM設計・Unixパーミッション整合性 |
| 監査ログ要件 | ファイルアクセスの監査ログを取得・保存する要件があるか | FSx ONTAPの監査設定・S3アーカイブ設計 |

---

## 4. 見積変数 整理

### Tier 1（これがないと見積もれない）

| 変数 | 単位 | 影響 |
|------|------|------|
| **移行元の種別（ANF or Azure VM上Windows FS）** | 種別 | **移行方式の根幹。SnapMirror使用可否** |
| ファイルサーバーのデータ容量 | GB/TB | 転送時間・FSx ONTAPのSSD容量設計 |
| ファイル数（総数） | 万件 | 転送時間・小ファイル問題の深刻度（SnapMirrorなら軽減） |
| ネットワーク帯域（Azure↔AWS間） | Mbps/Gbps | 転送日数・方式選択 |
| カットオーバー時の業務停止許容時間 | 時間 | 方式・段取り全体を決定 |
| 基幹システムのOSおよびDB | 種別/バージョン | EC2スペック・ライセンス種別 |

### Tier 2（方式・コスト精度に影響）

| 変数 | 単位 | 影響 |
|------|------|------|
| ファイルの変更頻度 | 日次変更量GB | 差分同期の実行回数・期間 |
| ADドメイン構成 | 同一/別 | 権限移行工数（最大2〜3倍変動） |
| SMB/NFSのどちらを使用するか | プロトコル種別 | FSx ONTAP SVM設計・マルチプロトコル要否 |
| 基幹システムの接続数/並列ユーザー数 | ユーザー数 | EC2スペック（メモリ・CPU） |
| バックアップ要件 | RPO/RTO | FSx ONTAPのSnapshot間隔・AWS Backup連携設計 |
| 暗号化要件 | 転送中/保存中 | KMS設定・追加設計工数 |

### Tier 3（要件として確認するが見積変動は小）

| 変数 | 影響 |
|------|------|
| FSx ONTAPのストレージティアリング（FabricPool）利用要否 | S3への自動階層化設計 |
| 監査ログ保持期間 | S3 Glacier等のアーカイブ設計 |
| 冗長化要件 | Multi-AZ / Single-AZ（ONTAPはマルチAZ対応） |
| DR要件（別リージョン） | SnapMirror Cross-region replication設計 |
| セキュリティ要件（WAF/SG設計） | EC2周辺の設計工数 |

---

## 5. 想定アーキテクチャ パターン3案

### Pattern A — SnapMirror直接移行（ANF → FSx for NetApp ONTAP）
```
[Azure NetApp Files (ANF)]
        │
    (SnapMirror / VPN or ExpressRoute)
        │
[FSx for NetApp ONTAP (SVM)]
        │
   [AWS VPC]
        │
[基幹システム EC2] — AD参加 → [AWS Managed Microsoft AD or 既存AD]
```
- 適用条件: 移行元がAzure NetApp Files（ANF）、VPN/DX経路あり or 新規構築
- メリット: ONTAPレベル転送で権限・メタデータ完全保持。小ファイル多数でも高速。差分レプリケーション可
- リスク: ANF使用前提。VPN/DXがなければ先行構築が必要

### Pattern B — DataSync移行（Azure VM上FS → FSx for NetApp ONTAP）
```
[Azure VM上 Windows FS]
        │
[DataSyncエージェント (Azure VM)]
        │ (インターネット or VPN/DX)
[AWS DataSync Service]
        │
[FSx for NetApp ONTAP (SVM)]
        │
[基幹システム EC2] — AD参加 → [AWS Managed Microsoft AD]
```
- 適用条件: 移行元がAzure VM上のWindows Server FS、管理コスト削減重視
- メリット: DataSyncがFSx for ONTAPをサポート。増分同期が標準機能
- リスク: 権限（NTFS ACL）の移行は追加スクリプト対応が必要。大量小ファイルはエージェント負荷増

### Pattern C — VPN構築 + 段階移行（ダウンタイム最小化）
```
[Azure FS (既存)] ←SnapMirror or DataSync継続同期→ [FSx for NetApp ONTAP (新設)]
        │                                                       │
   [Azure VNet]────────VPN/DX────────[AWS VPC]
                                             │
                                    [基幹システム EC2]
```
- 適用条件: ダウンタイム最小化最優先。段階的移行
- メリット: カットオーバー時の停止時間を最短（SNAPMirror最終同期なら数分）に短縮可
- リスク: VPN設計工数と、ANF使用時はSnapMirror設定コストが増える

---

## 6. 今すぐ確認すべき 最重要質問 Top10

> **火曜提出前に顧客への初回ヒアリングで必ず聞くこと**

| 優先 | 質問 | なぜ重要か |
|------|------|-----------|
| **1** | AzureのファイルサーバーはAzure NetApp Files（ANF）ですか？それともAzure VM上のWindows ServerのFSですか？ | **移行方式の根幹。ANFならSnapMirrorが最有力となり工期・品質が大幅向上** |
| **2** | ファイルサーバーの総データ容量とファイル総数は？ | 転送時間・方式・FSx ONTAPの容量設計の全て |
| **3** | カットオーバー時に業務を何時間停止できるか？ | 移行方式の選択を決定する |
| **4** | グループ会社と移行先のADドメインは同一か、別ドメインか？ | 権限移行の工数が2〜3倍変動する |
| **5** | Azure↔AWSの間にVPN/ExpressRoute等のネットワーク接続は存在するか、または新規構築予定か？ | SnapMirror/DataSync使用の前提条件 |
| **6** | 基幹システムのOS・DB・MWの種別とバージョンを教えてほしい | EC2スペックと対応AMI/ライセンスが決まる |
| **7** | 基幹システムのEC2新規構築はRe-host（Lift&Shift）か、それともリアーキテクチャを含むか？ | 工数が数倍変わる |
| **8** | FSx for ONTAPへのアクセスはSMBのみか、NFSも使用するか？ | SVM設計・マルチプロトコル要否に直結 |
| **9** | 移行後のバックアップ要件（RPO/RTO）と、DR（別リージョン等）の要件はあるか？ | FSx ONTAPのSnapshot/SnapMirror Cross-region設計が確定 |
| **10** | 想定稼働時期（本番カットオーバー目標日）はいつか？ | 移行期間の逆算とプロジェクト実現性の確認 |

---

## ステータス

- [ ] 初回ヒアリング実施（Top10確認）
- [ ] 移行元種別確定（ANF or Azure VM-FS）
- [ ] 方式確定（PatternA/B/C）
- [ ] 権限移行方針確定
- [ ] 概算見積提出
- [ ] 詳細ヒアリング（必要に応じ2回目）
- [ ] 正式見積提出
